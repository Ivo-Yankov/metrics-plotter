name: Add chart comment

on:
  pull_request_target:

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  build-and-screenshot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (PR head)
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Start http-server (background)
        run: |
          # start a simple static server in background
          npx http-server src -c-1 -p 8000 &
          # give server time to start
          sleep 2

      - name: Take screenshot
        run: |
          mkdir -p charts
          SCREENSHOT_WIDTH=1920 npm run screenshot -- http://127.0.0.1:8000\?hide-controls=true\&grouped=true charts/out.png

      - name: Upload screenshot artifact
        uses: actions/upload-artifact@v4
        with:
          name: screenshot
          path: charts/out.png

      - name: Comment on PR with screenshot
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = 'charts/out.png';
            if (!fs.existsSync(path)) {
              throw new Error('Screenshot not found at ' + path);
            }
            const data = fs.readFileSync(path, { encoding: 'base64' });
            const body = `Screenshot from workflow:\n\n![screenshot](data:image/png;base64,${data})`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            });
