name: Add chart comment

on:
  pull_request:

jobs:
  build-and-screenshot:
    permissions: write-all
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (PR head)
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Start http-server (background)
        run: |
          # start a simple static server in background
          npx http-server src -c-1 -p 8000 &
          # give server time to start
          sleep 2

      - name: Take screenshot
        run: |
          mkdir -p charts
          SCREENSHOT_WIDTH=1920 npm run screenshot -- http://127.0.0.1:8000\?hide-controls=true\&grouped=true charts/out.png

      - name: Upload screenshot artifact
        uses: actions/upload-artifact@v4
        with:
          name: screenshot
          path: charts/out.png

      - name: Read screenshot and encode
        id: read_screenshot
        run: |
          if [ ! -f charts/out.png ]; then echo "Screenshot not found"; exit 1; fi
          echo "img=$(base64 -w 0 charts/out.png)" >> $GITHUB_OUTPUT

      - name: Create PR comment with screenshot
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            Screenshot from workflow:

            ![screenshot](data:image/png;base64,${{ steps.read_screenshot.outputs.img }})
